<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="开始妹子都喜欢流星，如果她说不喜欢，那她一定是一个假妹子。
现在就一起来做一场流星雨，用程序员的野路子浪漫一下。
要画一场流星雨，首先，自然我们要会画一颗流星。
玩过 canvas 的同学，你画圆画方画线条这么 6，如果说叫你画下面这个玩意儿，你会不会觉得你用的是假 canvas？canvas 没有">
    

    <!--Author-->
    
        <meta name="author" content="zzc">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="撩妹技能 get，教你用 canvas 画一场流星雨"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Chaz&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>撩妹技能 get，教你用 canvas 画一场流星雨 - Chaz&#39;s blog</title>

    <!-- Tachyons Core CSS -->
    <link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/style.css">

    <!-- Google Analytics -->
    

</head>


<body>

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<div class="w-100 bg-1 ph5-ns ph3 text-light">
    
    <nav class="db dt-l w-100 mw8 center border-box pv3">
        <a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/blog/" title="Chaz's blog">
            
            <img src="/blog/images/avatar.jpg" class="v-mid dib h2 br-100" alt="Chaz's blog"> &nbsp; Chaz
        </a>
        <div class="db dtc-l v-mid w-100 w-75-l tc tr-l">
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/blog/blog" 
                    title="首页">
                    首页
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/blog/archives" 
                    title="归档">
                    归档
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="http://gnauhca.com" 
                    title="关于">
                    关于
                </a>
            
        </div>
    </nav>

    <!-- Title -->
    <div class="w-100 mw8 center vh-40 dt">
        <div class="dtc v-mid white">
            <h1 class="f1-l f2-m tc tc-m tl-ns" style="font-size: 3rem; text-shadow: rgba(0,0,0,.03) 2px 2px, rgba(0,0,0,.0285) 4px 4px, rgba(0,0,0,.0270) 6px 6px, rgba(0,0,0,.0255) 8px 8px, rgba(0,0,0,.0240) 10px 10px, rgba(0,0,0,.0225) 12px 12px, rgba(0,0,0,.0210) 14px 14px, rgba(0,0,0,.0195) 16px 16px, rgba(0,0,0,.0180) 18px 18px, rgba(0,0,0,.0165) 20px 20px, rgba(0,0,0,.0150) 22px 22px, rgba(0,0,0,.0135) 24px 24px, rgba(0,0,0,.0120) 26px 26px, rgba(0,0,0,.0105) 28px 28px, rgba(0,0,0,.0090) 30px 30px, rgba(0,0,0,.0075) 32px 32px, rgba(0,0,0,.0060) 34px 34px, rgba(0,0,0,.0045) 36px 36px, rgba(0,0,0,.0030) 38px 38px, rgba(0,0,0,.0015) 40px 40px">撩妹技能 get，教你用 canvas 画一场流星雨</h1>
            <p class="f4 fw1 pab-100px tc tc-m tl-ns">2017-02-13</p>
        </div>
    </div>

    <!-- Icon
    <div class="relative w-100 mw8 center white dn dn-m db-ns">
        <i class="header-icon fa fa-file-text-o"></i>
    </div> -->
</div>

<!-- Content -->
<div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l">
    <div class="content">
        <div class="mw8 center">
            <div class="cf">
                <div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content">
                    <!-- Tags Vertical -->
                    
                        <div class="tags-container-vertical">
                            <div class="tags-sub-container">
                                <a class="fw3 ph1 dib" href="/blog/tags/canvas/">#canvas</a>
                            </div>
                        </div>
                    

                    <!-- Main Post Content -->
                    <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>妹子都喜欢流星，如果她说不喜欢，那她一定是一个假妹子。</p>
<p>现在就一起来做一场流星雨，用程序员的野路子浪漫一下。</p>
<p>要画一场流星雨，首先，自然我们要会画一颗流星。</p>
<p>玩过 canvas 的同学，你画圆画方画线条这么 6，如果说叫你画下面这个玩意儿，你会不会觉得你用的是假 canvas？canvas 没有画一个带尾巴玩意儿的 api 啊。</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/star1.gif" alt="star1.gif" title="">
<h2 id="画一颗流星"><a href="#画一颗流星" class="headerlink" title="画一颗流星"></a>画一颗流星</h2><p>是的，的却是没这个 api，但是不代表我们画不出来。流星就是一个小石头，然后因为速度过快产生大量的热量带动周围的空气发光发热，所以经飞过的地方看起来就像是流星的尾巴，我们先研究一下流星这个图像，整个流星处于他自己的运动轨迹之中，当前的位置最亮，轮廓最清晰，而之前划过的地方离当前位置轨迹距离越远就越暗淡越模糊。</p>
<p>上面的分析结果很关键， canvas 上是每一帧就重绘一次，每一帧之间的时间间隔很短。流星经过的地方会越来越模糊最后消失不见，那有没有可以让画布画的图像每过一帧就变模糊一点而不是全部清除的办法？如果可以这样，就可以把每一帧用线段画一小段流星的运动轨迹，最后画出流星的效果。</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/silu1.jpg" alt="silu1.jpg" title="">
<p>骗纸！你也许会说，这那里像流星了？？？<br>别急，让我多画几段给你看看。</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/silu2.jpg" alt="silu2.jpg" title="">
<p>什么？ 还是不像？ 我们把它画小点，这下总该像了把？</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/silu3.jpg" alt="silu3.jpg" title="">
<p>上面几幅图我是在 ps 上模拟的，本质上 ps 也是在画布上绘画，我们马上在 canvas 上试试。</p>
<p>那，直接代码实现一下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 坐标</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crood</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(x=0, y=0) &#123;</div><div class="line">        <span class="keyword">this</span>.x = x;</div><div class="line">        <span class="keyword">this</span>.y = y;</div><div class="line">    &#125;</div><div class="line">    setCrood(x, y) &#123;</div><div class="line">        <span class="keyword">this</span>.x = x;</div><div class="line">        <span class="keyword">this</span>.y = y;</div><div class="line">    &#125;</div><div class="line">    copy() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Crood(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 流星</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShootingStar</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(init=new Crood, final=new Crood, size=3, speed=200, onDistory=null) &#123;</div><div class="line">        <span class="keyword">this</span>.init = init; <span class="comment">// 初始位置</span></div><div class="line">        <span class="keyword">this</span>.final = final; <span class="comment">// 最终位置</span></div><div class="line">        <span class="keyword">this</span>.size = size; <span class="comment">// 大小</span></div><div class="line">        <span class="keyword">this</span>.speed = speed; <span class="comment">// 速度：像素/s</span></div><div class="line"></div><div class="line">        <span class="comment">// 飞行总时间</span></div><div class="line">        <span class="keyword">this</span>.dur = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(<span class="keyword">this</span>.final.x-<span class="keyword">this</span>.init.x, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(<span class="keyword">this</span>.final.y-<span class="keyword">this</span>.init.y, <span class="number">2</span>)) * <span class="number">1000</span> / <span class="keyword">this</span>.speed; </div><div class="line"></div><div class="line">        <span class="keyword">this</span>.pass = <span class="number">0</span>; <span class="comment">// 已过去的时间</span></div><div class="line">        <span class="keyword">this</span>.prev = <span class="keyword">this</span>.init.copy(); <span class="comment">// 上一帧位置</span></div><div class="line">        <span class="keyword">this</span>.now = <span class="keyword">this</span>.init.copy(); <span class="comment">// 当前位置</span></div><div class="line">        <span class="keyword">this</span>.onDistory = onDistory;</div><div class="line">    &#125;</div><div class="line">    draw(ctx, delta) &#123;</div><div class="line">        <span class="keyword">this</span>.pass += delta;</div><div class="line">        <span class="keyword">this</span>.pass = <span class="built_in">Math</span>.min(<span class="keyword">this</span>.pass, <span class="keyword">this</span>.dur);</div><div class="line"></div><div class="line">        <span class="keyword">let</span> percent = <span class="keyword">this</span>.pass / <span class="keyword">this</span>.dur;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.now.setCrood(</div><div class="line">            <span class="keyword">this</span>.init.x + (<span class="keyword">this</span>.final.x - <span class="keyword">this</span>.init.x) * percent,</div><div class="line">            <span class="keyword">this</span>.init.y + (<span class="keyword">this</span>.final.y - <span class="keyword">this</span>.init.y) * percent</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="comment">// canvas</span></div><div class="line">        ctx.strokeStyle = <span class="string">'#fff'</span>;</div><div class="line">        ctx.lineCap = <span class="string">'round'</span>;</div><div class="line">        ctx.lineWidth = <span class="keyword">this</span>.size;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.moveTo(<span class="keyword">this</span>.now.x, <span class="keyword">this</span>.now.y);</div><div class="line">        ctx.lineTo(<span class="keyword">this</span>.prev.x, <span class="keyword">this</span>.prev.y);</div><div class="line">        ctx.stroke();</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.prev.setCrood(<span class="keyword">this</span>.now.x, <span class="keyword">this</span>.now.y);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.pass === <span class="keyword">this</span>.dur) &#123;</div><div class="line">            <span class="keyword">this</span>.distory();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    distory() &#123;</div><div class="line">        <span class="keyword">this</span>.onDistory &amp;&amp; <span class="keyword">this</span>.onDistory();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// effet</span></div><div class="line"><span class="keyword">let</span> cvs = <span class="built_in">document</span>.querySelector(<span class="string">'canvas'</span>);</div><div class="line"><span class="keyword">let</span> ctx = cvs.getContext(<span class="string">'2d'</span>);</div><div class="line"></div><div class="line"><span class="keyword">let</span> T;</div><div class="line"><span class="keyword">let</span> shootingStar = <span class="keyword">new</span> ShootingStar(</div><div class="line">                        <span class="keyword">new</span> Crood(<span class="number">100</span>, <span class="number">100</span>), </div><div class="line">                        <span class="keyword">new</span> Crood(<span class="number">400</span>, <span class="number">400</span>),</div><div class="line">                        <span class="number">3</span>,</div><div class="line">                        <span class="number">200</span>,</div><div class="line">                        ()=&gt;&#123;cancelAnimationFrame(T)&#125;</div><div class="line">                    );</div><div class="line"></div><div class="line"><span class="keyword">let</span> tick = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">let</span> now = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime();</div><div class="line">	<span class="keyword">let</span> last = now;</div><div class="line">	<span class="keyword">let</span> delta;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		delta = now - last;</div><div class="line">		delta = delta &gt; <span class="number">500</span> ? <span class="number">30</span> : (delta &lt; <span class="number">16</span>? <span class="number">16</span> : delta);</div><div class="line">		last = now;</div><div class="line">        <span class="comment">// console.log(delta);</span></div><div class="line"></div><div class="line">        T = requestAnimationFrame(tick);</div><div class="line"></div><div class="line">        ctx.save();</div><div class="line">        ctx.fillStyle = <span class="string">'rgba(0,0,0,0.2)'</span>; <span class="comment">// 每一帧用 “半透明” 的背景色清除画布</span></div><div class="line">        ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, cvs.width, cvs.height);</div><div class="line">        ctx.restore();</div><div class="line">		shootingStar.draw(ctx, delta);</div><div class="line">	&#125;</div><div class="line">&#125;)();</div><div class="line">tick();</div></pre></td></tr></table></figure>
<h4 id="效果：一颗流星"><a href="#效果：一颗流星" class="headerlink" title="效果：一颗流星"></a>效果：一颗流星</h4><img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/star1.gif" alt="star1.gif" title="">
<p>sogoyi 快看，一颗活泼不做作的流星!!! 是不是感觉动起来更加逼真一点？</p>
<h2 id="流星雨"><a href="#流星雨" class="headerlink" title="流星雨"></a>流星雨</h2><p>我们再加一个流星雨 MeteorShower 类，生成多一些随机位置的流星，做出流星雨。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 坐标</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crood</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(x=0, y=0) &#123;</div><div class="line">        <span class="keyword">this</span>.x = x;</div><div class="line">        <span class="keyword">this</span>.y = y;</div><div class="line">    &#125;</div><div class="line">    setCrood(x, y) &#123;</div><div class="line">        <span class="keyword">this</span>.x = x;</div><div class="line">        <span class="keyword">this</span>.y = y;</div><div class="line">    &#125;</div><div class="line">    copy() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Crood(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 流星</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShootingStar</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(init=new Crood, final=new Crood, size=3, speed=200, onDistory=null) &#123;</div><div class="line">        <span class="keyword">this</span>.init = init; <span class="comment">// 初始位置</span></div><div class="line">        <span class="keyword">this</span>.final = final; <span class="comment">// 最终位置</span></div><div class="line">        <span class="keyword">this</span>.size = size; <span class="comment">// 大小</span></div><div class="line">        <span class="keyword">this</span>.speed = speed; <span class="comment">// 速度：像素/s</span></div><div class="line"></div><div class="line">        <span class="comment">// 飞行总时间</span></div><div class="line">        <span class="keyword">this</span>.dur = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(<span class="keyword">this</span>.final.x-<span class="keyword">this</span>.init.x, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(<span class="keyword">this</span>.final.y-<span class="keyword">this</span>.init.y, <span class="number">2</span>)) * <span class="number">1000</span> / <span class="keyword">this</span>.speed; </div><div class="line"></div><div class="line">        <span class="keyword">this</span>.pass = <span class="number">0</span>; <span class="comment">// 已过去的时间</span></div><div class="line">        <span class="keyword">this</span>.prev = <span class="keyword">this</span>.init.copy(); <span class="comment">// 上一帧位置</span></div><div class="line">        <span class="keyword">this</span>.now = <span class="keyword">this</span>.init.copy(); <span class="comment">// 当前位置</span></div><div class="line">        <span class="keyword">this</span>.onDistory = onDistory;</div><div class="line">    &#125;</div><div class="line">    draw(ctx, delta) &#123;</div><div class="line">        <span class="keyword">this</span>.pass += delta;</div><div class="line">        <span class="keyword">this</span>.pass = <span class="built_in">Math</span>.min(<span class="keyword">this</span>.pass, <span class="keyword">this</span>.dur);</div><div class="line"></div><div class="line">        <span class="keyword">let</span> percent = <span class="keyword">this</span>.pass / <span class="keyword">this</span>.dur;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.now.setCrood(</div><div class="line">            <span class="keyword">this</span>.init.x + (<span class="keyword">this</span>.final.x - <span class="keyword">this</span>.init.x) * percent,</div><div class="line">            <span class="keyword">this</span>.init.y + (<span class="keyword">this</span>.final.y - <span class="keyword">this</span>.init.y) * percent</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="comment">// canvas</span></div><div class="line">        ctx.strokeStyle = <span class="string">'#fff'</span>;</div><div class="line">        ctx.lineCap = <span class="string">'round'</span>;</div><div class="line">        ctx.lineWidth = <span class="keyword">this</span>.size;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.moveTo(<span class="keyword">this</span>.now.x, <span class="keyword">this</span>.now.y);</div><div class="line">        ctx.lineTo(<span class="keyword">this</span>.prev.x, <span class="keyword">this</span>.prev.y);</div><div class="line">        ctx.stroke();</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.prev.setCrood(<span class="keyword">this</span>.now.x, <span class="keyword">this</span>.now.y);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.pass === <span class="keyword">this</span>.dur) &#123;</div><div class="line">            <span class="keyword">this</span>.distory();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    distory() &#123;</div><div class="line">        <span class="keyword">this</span>.onDistory &amp;&amp; <span class="keyword">this</span>.onDistory();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MeteorShower</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(cvs, ctx) &#123;</div><div class="line">        <span class="keyword">this</span>.cvs = cvs;</div><div class="line">        <span class="keyword">this</span>.ctx = ctx;</div><div class="line">        <span class="keyword">this</span>.stars = [];</div><div class="line">        <span class="keyword">this</span>.T;</div><div class="line">        <span class="keyword">this</span>.stop = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.playing = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    createStar() &#123;</div><div class="line">        <span class="keyword">let</span> angle = <span class="built_in">Math</span>.PI / <span class="number">3</span>;</div><div class="line">        <span class="keyword">let</span> distance = <span class="built_in">Math</span>.random() * <span class="number">400</span>;</div><div class="line">        <span class="keyword">let</span> init = <span class="keyword">new</span> Crood(<span class="built_in">Math</span>.random() * <span class="keyword">this</span>.cvs.width|<span class="number">0</span>, <span class="built_in">Math</span>.random() * <span class="number">100</span>|<span class="number">0</span>);</div><div class="line">        <span class="keyword">let</span> final = <span class="keyword">new</span> Crood(init.x + distance * <span class="built_in">Math</span>.cos(angle), init.y + distance * <span class="built_in">Math</span>.sin(angle));</div><div class="line">        <span class="keyword">let</span> size = <span class="built_in">Math</span>.random() * <span class="number">2</span>;</div><div class="line">        <span class="keyword">let</span> speed = <span class="built_in">Math</span>.random() * <span class="number">400</span> + <span class="number">100</span>;</div><div class="line">        <span class="keyword">let</span> star = <span class="keyword">new</span> ShootingStar(</div><div class="line">                        init, final, size, speed, </div><div class="line">                        ()=&gt;&#123;<span class="keyword">this</span>.remove(star)&#125;</div><div class="line">                    );</div><div class="line">        <span class="keyword">return</span> star;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    remove(star) &#123;</div><div class="line">        <span class="keyword">this</span>.stars = <span class="keyword">this</span>.stars.filter(<span class="function">(<span class="params">s</span>)=&gt;</span>&#123; <span class="keyword">return</span> s !== star&#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    update(delta) &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.stop &amp;&amp; <span class="keyword">this</span>.stars.length &lt; <span class="number">20</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.stars.push(<span class="keyword">this</span>.createStar());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.stars.forEach(<span class="function">(<span class="params">star</span>)=&gt;</span>&#123;</div><div class="line">            star.draw(<span class="keyword">this</span>.ctx, delta);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    tick() &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.playing) <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">this</span>.playing = <span class="literal">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">let</span> now = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime();</div><div class="line">        <span class="keyword">let</span> last = now;</div><div class="line">        <span class="keyword">let</span> delta;</div><div class="line"></div><div class="line">        <span class="keyword">let</span>  _tick = <span class="function"><span class="params">()</span>=&gt;</span>&#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.stop &amp;&amp; <span class="keyword">this</span>.stars.length === <span class="number">0</span>) &#123;</div><div class="line">                cancelAnimationFrame(<span class="keyword">this</span>.T);</div><div class="line">                <span class="keyword">this</span>.playing = <span class="literal">false</span>;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            delta = now - last;</div><div class="line">            delta = delta &gt; <span class="number">500</span> ? <span class="number">30</span> : (delta &lt; <span class="number">16</span>? <span class="number">16</span> : delta);</div><div class="line">            last = now;</div><div class="line">            <span class="comment">// console.log(delta);</span></div><div class="line"></div><div class="line">            <span class="keyword">this</span>.T = requestAnimationFrame(_tick);</div><div class="line"></div><div class="line">            ctx.save();</div><div class="line">            ctx.fillStyle = <span class="string">'rgba(0,0,0,0.2)'</span>; <span class="comment">// 每一帧用 “半透明” 的背景色清除画布</span></div><div class="line">            ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, cvs.width, cvs.height);</div><div class="line">            ctx.restore();</div><div class="line">            <span class="keyword">this</span>.update(delta);</div><div class="line">        &#125;</div><div class="line">        _tick();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    start() &#123;</div><div class="line">        <span class="keyword">this</span>.stop = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.tick();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    stop() &#123;</div><div class="line">        <span class="keyword">this</span>.stop = <span class="literal">true</span>;</div><div class="line">    &#125;  </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// effet</span></div><div class="line"><span class="keyword">let</span> cvs = <span class="built_in">document</span>.querySelector(<span class="string">'canvas'</span>);</div><div class="line"><span class="keyword">let</span> ctx = cvs.getContext(<span class="string">'2d'</span>);</div><div class="line"></div><div class="line"><span class="keyword">let</span> meteorShower = <span class="keyword">new</span> MeteorShower(cvs, ctx);</div><div class="line">meteorShower.start();</div></pre></td></tr></table></figure>
<h4 id="效果：流星雨"><a href="#效果：流星雨" class="headerlink" title="效果：流星雨"></a>效果：流星雨</h4><img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/star2.gif" alt="star2.gif" title="">
<h2 id="透明背景"><a href="#透明背景" class="headerlink" title="透明背景"></a>透明背景</h2><p>先不急着激动，这个流星雨有点单调，可以看到上面的代码中，每一帧，我们用了透明度为 0.2 的黑色刷了一遍画布，背景漆黑一片，如果说我们的需求是透明背景呢？ </p>
<p>比如，我们要用这个夜景图片做背景，然后在上面加上我们的流星，我们每一帧刷一层背景的小伎俩就用不了啦。因为我们要保证除开流星之外的部分，应该是透明的。</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/bg.jpg" alt="bg.jpg" title="">
<p>这里就要用到一个冷门的属性了，globalCompositeOperation，全局组合操作？ 原谅我放荡不羁的翻译。<br>这个属性其实就是用来定义后绘制的图形与先绘制的图形之间的组合显示效果的。<br>他可以设置这些值</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/globalcompositeoperation.jpg" alt="globalcompositeoperation.jpg" title="">
<p>这些属性说明没必要仔细看，更不用记下来，直接看 <a href="http://www.w3school.com.cn/tiy/t.asp?f=html5_canvas_globalcompop_all" target="_blank" rel="external">api 示例</a> 运行效果就很清楚了。示例里，先绘制的是填充正方形，后绘制的是填充圆形。</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/globalcompositeoperation-demo.jpg" alt="globalcompositeoperation-demo.jpg" title="">
<p>是不是豁然开朗，一目了然？</p>
<p>对于我们来说，原图像是每一帧画完的所有流星，目标图像是画完流星之后半透明覆盖画布的黑色矩形。而我们每一帧要保留的就是，上一帧 0.8 透明度的流星，覆盖画布黑色矩形我们不能显示。</p>
<p>注意这里的 destination-out 和 destination-in，示例中这两个属性最终都只有部分源图像保留了下来，符合我们只要保留流星的需求。我觉得 w3cschool 上描述的不是很正确，我用我自己的理解概括一下。</p>
<p>destination-in：只保留了源图像（矩形）和目标图像（圆）交集区域的源图像<br>destination-out：只保留了源图像（矩形）减去目标图像（圆）之后区域的源图像</p>
<p>上诉示例目标图像的透明度是 1，源图像被减去的部分是完全不见了。而我们想要的是他可以按照目标透明度进行部分擦除。改一下示例里的代码看看是否支持半透明的计算。</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/globalcompositeoperation-alpha.jpg" alt="globalcompositeoperation-alpha.jpg" title="">
<p>看来这个属性支持半透明的计算。源图像和目标图像交叠的部分以半透明的形式保留了下来。也就是说如果我们要保留 0.8 透明度的流星，可以这样设置 globalCompositeOperation</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ctx.fillStyle = <span class="string">'rgba(0,0,0,0.8)'</span></div><div class="line">globalCompositeOperation = <span class="string">'destination-in'</span>;</div><div class="line">ctx.fillRect(cvs.width, cvs.height);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 或者</span></div><div class="line">ctx.fillStyle = <span class="string">'rgba(0,0,0,0.2)'</span></div><div class="line">globalCompositeOperation = <span class="string">'destination-out'</span>;</div><div class="line">ctx.fillRect(cvs.width, cvs.height);</div></pre></td></tr></table></figure>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p>加上 globalCompositeOperation 之后的效果既最终效果：</p>
<img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/star3.gif" alt="star3.gif" title="">
<p><a href="https://github.com/gnauhca/dailyeffecttest/tree/master/b-meteorshower" target="_blank" rel="external">github: https://github.com/gnauhca/dailyeffecttest/tree/master/b-meteorshower</a></p>
<p>快约上你的妹子看流星雨吧。</p>
<p>…什么，你没有妹子？<br><img src="/blog/2017/02/13/canvas/撩妹技能%20get，教你用%20canvas%20画一场流星雨/wenhao.jpg" alt="wenhao.jpg" title=""></p>

                    
                    <!-- Tags Bottom -->
                    
                        <div class="tags-container-bottom">
                            <i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/blog/tags/canvas/">#canvas</a>
                        </div>
                    

                    <!-- Comments -->
                    



                </div>
                <div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50">
                    
                    <hr class="dn-l mw4 black-50 mt5" />
                    
                    <!-- Widget 1: About -->
                    <div class="mt5 mt0-l">
    <article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3">
        <div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width: 6rem;">
            <img src="/blog/images/avatar.jpg" class="mb4-l h3 w3 h4-l w4-l dib" title="zzc">
        </div>
        <div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">
            My name is Zhouzhichuang. You can call me Chaz. I was born in 1991s.
        </div>
    </article>
</div>

                    <hr class="dn-l mw4 black-50 mt5" />
                    
                    <!-- Widget 2: Categories -->
                    
                        <div class="mt5 tc tl-l">
    <h3>分类</h3>
    
        <p>
            <a href="/blog/categories/canvas/">canvas</a>
        </p>
    
</div>


                        <hr class="dn-l mw4 black-50 mt5" />
                    

                    <!-- Widget 3: Recent Posts -->
                    <div class="mt5 tc tl-l">
    <h3>最新文章</h3>
    
        <p>
            <a href="/blog/2017/03/13/js/什么？你还在用数组存储一组用布尔值？/">Untitled</a>
        </p>
    
        <p>
            <a href="/blog/2017/02/13/canvas/撩妹技能 get，教你用 canvas 画一场流星雨/">撩妹技能 get，教你用 canvas 画一场流星雨</a>
        </p>
    
        <p>
            <a href="/blog/2017/02/11/linux/shell基础/">Shell 基础</a>
        </p>
    
        <p>
            <a href="/blog/2016/11/24/css/用CSS3做一个圆形镂空的漂亮蒙层/">用 CSS 3 做一个镂空的蒙层</a>
        </p>
    
        <p>
            <a href="/blog/2016/11/24/threejs/THREEJS屏幕适配/">简单一招搞定 three.js 屏幕适配</a>
        </p>
    
</div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<div class="bg-1 ph2 ph5-ns pv4">
        <div class="mv8">
            <div class="center tc">
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://github.com/gnauhca" target="_blank">
                            <i class="fa fa-github"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://codepen.io/gnauhca/" target="_blank">
                            <i class="fa fa-codepen"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="mailto:576073927@qq.com" target="_blank">
                            <i class="fa fa-envelope"></i>
                        </a>
                    </div>
                
            </div>
            <!--div class="f6 f5-ns center tc white pt5 fw3">
                
            </div-->
        </div>
    </div>

<!-- After Footer -->
<!-- Disqus Comments -->



</body>

</html>